#!/bin/sh

formatted_issue_line_jq_query='.[] | "\u001b[\(if .state == "CLOSED" then "35" else "32" end)m#\(.number)\u001b[39m \(.title)"'
issue_view_command_template=$(
	cat <<-"EOF"
		issue_number={1}
		issue_number=${issue_number:1}
		GH_FORCE_TTY=$FZF_PREVIEW_COLUMNS NO_COLOR=yes gh issue view --<action> $issue_number
	EOF
)
preview_command=${issue_view_command_template//<action>/comments}
open_in_web_command=${issue_view_command_template//<action>/web}
issue_list_command=$(
	cat <<-EOF
		gh issue list \
		    --state=all \
		    --limit=100 \
		    --json=number,title,state \
		    --jq=${formatted_issue_line_jq_query@Q}
	EOF
)
fzf --disabled \
    --no-input \
    --ansi \
    --preview="$preview_command" \
    --bind="start,ctrl-r:reload($issue_list_command)" \
    --bind="ctrl-space:execute-silent($open_in_web_command)"
