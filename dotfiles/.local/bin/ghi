#!/bin/sh

issue_view_command_template=$(
	cat <<-"EOF"
		issue_number={1}
		issue_number=${issue_number:1}
		GH_ACCESSIBLE_COLORS=yes GH_FORCE_TTY=$FZF_PREVIEW_COLUMNS gh issue view --<action> $issue_number
	EOF
)
preview_command=${issue_view_command_template//<action>/comments}
open_in_web_command=${issue_view_command_template//<action>/web}
formatted_issue_lines_jq_query=$(
	cat <<-"EOF"
		"\u001b[" as $csi |
		"32" as $green |
		"35" as $magenta |
		"39" as $reset_foreground |
		.[] |
		(if .state == "CLOSED" then $magenta else $green end) as $color |
		"\($csi)\($color)m#\(.number)\($csi)\($reset_foreground)m \(.title)"
	EOF
)
quoted_formatted_issue_lines_jq_query=${formatted_issue_lines_jq_query@Q}
issue_list_command=$(
	cat <<-EOF
		query={q}
		gh issue list \
		    --state=all \
		    --limit=100 \
		    --json=number,title,state \
		    \${query:+--search="\$query"} \
		    --jq=$quoted_formatted_issue_lines_jq_query
	EOF
)
fzf --disabled \
    --ansi \
    --preview="$preview_command" \
    --bind="start,enter:reload($issue_list_command)+first" \
    --bind="ctrl-space:execute-silent($open_in_web_command)"
