#!/bin/sh

status_command=$(
	cat <<-"EOC"
		date_string=$(date "+%A %B %d %H:%M:%S %Y")
		IFS="," read memory_string memory_second_bar_index < <(
			python <<-EOP
				from subprocess import check_output
				from itertools import batched
				free_output = check_output(("free", "--line", "--human"), text=True)
				formatted_statistics = list(f"{stat}: {value}" for stat, value in batched(free_output.split(), n=2))
				seperator = "  |  "
				memory_string = seperator.join(formatted_statistics)
				memory_second_bar_index = sum(len(formatted_statistics[i]) for i in (0, 1)) + len(seperator) + len(seperator) // 2
				print(f"{memory_string},{memory_second_bar_index}")
			EOP
		)
		uptime_string=$(uptime --pretty)
		padding=2
		total_width=$COLUMNS
		middle_column=$(($total_width / 2))
		date_end=$(($padding + ${#date_string}))
		memory_start=$(($middle_column - $memory_second_bar_index))
		left_gap_width=$(($memory_start - $date_end))
		memory_end=$(($memory_start + ${#memory_string}))
		uptime_start=$(($total_width - $padding - ${#uptime_string}))
		right_gap_width=$(($uptime_start - $memory_end))
		printf "%${padding}s"
		printf "$date_string"
		printf "%${left_gap_width}s"
		printf "$memory_string"
		printf "%${right_gap_width}s"
		printf "$uptime_string"
	EOC
)
kitty +kitten panel \
    --override window_padding_width=2 \
    --override placement_strategy=center \
    --override font_size=12 \
    watch --no-title --color --interval=1 "$status_command"
