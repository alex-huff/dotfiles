#!/bin/sh

read -rd "" rg_prefix <<EOF
rg \
    --color=always \
    --hyperlink-format=kitty \
    --with-filename \
    --column \
    --line-number \
    --no-heading \
    --smart-case \
    --field-match-separator \
    ":\0"
EOF
read -rd "" print_quoted_absolute_path <<"EOF"
given_path={1}
case "$given_path"
in
    /*)
        absolute_path="$given_path"
    ;;
    *)
        absolute_path="${PWD}/$given_path"
    ;;
esac
printf "%q" "$absolute_path"
EOF
rg_args=${*@Q}
FZF_DEFAULT_COMMAND=":" fzf \
    --delimiter ":\0" \
    --ansi \
    --disabled \
    --preview "bat --color=always --style=plain --highlight-line {2} {1}" \
    --preview-window "+{2}/2" \
    --bind "resize:refresh-preview" \
    --bind "change:reload:$rg_prefix {q} $rg_args || true" \
    --bind "ctrl-space:execute(nvim -f {1} -c 'normal '{2}G{3}'|zz')" \
    --bind "enter:execute-silent($print_quoted_absolute_path | kitty +kitten clipboard)" > /dev/null
